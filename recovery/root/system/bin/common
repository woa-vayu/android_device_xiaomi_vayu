#!/sbin/bash
partedcmd="parted -s /dev/block/sda"
win=/dev/block/sda33
esp=/dev/block/sda34
gpt_dead(){ echo "this script will NOT work with weird partition layouts! please restore the partition table by flashing gpt_both0 in fastboot or using your brain and parted!"; exit 1;}
removeparts(){ for i in 34 33 32; do $partedcmd rm $i 2>/dev/null; done }
formatwinesp(){
mkfs.fat -F32 -s1 $esp -n ESPVAYU
mkfs.ntfs -f $win -L WINVAYU
}
for i in 1 2 3 4; do test -e /dev/block/by-name/bk0$i || gpt_dead; done
[ -e /dev/block/sda35 ] && gpt_dead
[ -e /config/usb_gadget/g1/configs/b.1/mass_storage.0 ] && echo "msc is enabled! aborting..." && echo "reboot and run the script again." && exit 1
if getprop sys.usb.config|grep -q "mtp"; then
echo "run the script again!";sleep 1
setprop sys.usb.config adb
rm /config/usb_gadget/g1/configs/b.1/f*
exit
fi
blocksize=$(blockdev --getsize64 /dev/block/sda)
if [[ $blocksize =~ ^126[0-9]{9}$ ]]; then max=127
elif [[ $blocksize =~ ^254[0-9]{9}$ ]]; then max=255
else echo "is this vayu?"; exit 1
fi
twrp umount data &> /dev/null
for i in esp win; do umount -lf /dev/block/by-name/$i 2> /dev/null; done
